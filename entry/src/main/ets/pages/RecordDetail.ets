// Router is now accessed through UIContext
// PromptAction is now accessed through UIContext
import preferences from '@ohos.data.preferences'
import common from '@ohos.app.ability.common'
import { StudyRecord, RouterParams } from '../models/types'

@Entry
@Component
struct RecordDetail {
  @State date: string = ''
  @State status: string = ''
  @State note: string = ''
  @State currentWeekDates: number[] = []

  private weekDays: string[] = ['å…­', 'æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”']

  aboutToAppear() {
    const params = this.getUIContext().getRouter().getParams() as RouterParams
    this.date = params?.date || ''
    this.status = params?.status || ''
    this.calculateWeekDates()
  }

  calculateWeekDates() {
    const dateObj = new Date(this.date)
    const day = dateObj.getDate()
    const weekDay = dateObj.getDay()

    // è®¡ç®—æœ¬å‘¨æ—¥æœŸ
    const startOfWeek = day - weekDay
    this.currentWeekDates = []
    for (let i = 0; i < 7; i++) {
      this.currentWeekDates.push(startOfWeek + i)
    }
  }

  formatDisplayDate(): string {
    const dateObj = new Date(this.date)
    const month = (dateObj.getMonth() + 1).toString().padStart(2, '0')
    const day = dateObj.getDate().toString().padStart(2, '0')
    return `${month}.${day} è®¡æ•°`
  }

  getStatusIcon(): string {
    return this.status === 'completed' ? 'âœ…' : 'ðŸ“'
  }

  getStatusText(): string {
    return this.status === 'completed' ? 'ä½œä¸šåšå®Œäº†' : 'åšäº†ï¼Œå‡†å¤‡æŠ„äº†'
  }

  async saveRecord() {
    try {
      // èŽ·å–preferenceså®žä¾‹
      const dataPreferences = await preferences.getPreferences((this.getUIContext().getHostContext() as common.UIAbilityContext), 'study_records')

      // è¯»å–çŽ°æœ‰è®°å½•
      const recordsStr = await dataPreferences.get('records', '[]') as string
      const records: StudyRecord[] = JSON.parse(recordsStr)

      // æ·»åŠ æ–°è®°å½•
      const newRecord: StudyRecord = {
        date: this.date,
        status: this.status as 'completed' | 'copied',
        note: this.note,
        timestamp: Date.now()
      }

      // æ£€æŸ¥æ˜¯å¦å·²æœ‰åŒæ—¥æœŸè®°å½•ï¼Œå¦‚æžœæœ‰åˆ™æ›´æ–°
      const existingIndex = records.findIndex((r: StudyRecord) => r.date === this.date)
      if (existingIndex >= 0) {
        records[existingIndex] = newRecord
      } else {
        records.push(newRecord)
      }

      // ä¿å­˜è®°å½•
      await dataPreferences.put('records', JSON.stringify(records))
      await dataPreferences.flush()

      this.getUIContext().getPromptAction().showToast({
        message: 'è®°å½•ä¿å­˜æˆåŠŸ',
        duration: 2000
      })

      // è¿”å›žä¸»é¡µ
      this.getUIContext().getRouter().back()
    } catch (error) {
      this.getUIContext().getPromptAction().showToast({
        message: 'ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•',
        duration: 2000
      })
    }
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆª
      Row() {
        Image($r('app.media.back'))
          .width(24)
          .height(24)
          .onClick(() => {
            this.getUIContext().getRouter().back()
          })

        Blank()
      }
      .width('100%')
      .padding(16)

      // çŠ¶æ€å›¾æ ‡
      Text(this.getStatusIcon())
        .fontSize(60)
        .margin({ top: 40, bottom: 20 })

      // çŠ¶æ€æ–‡å­—
      Text(this.getStatusText())
        .fontSize(24)
        .fontColor('#FFFFFF')
        .fontWeight(FontWeight.Medium)
        .margin({ bottom: 40 })

      // æ—¥æœŸæ˜¾ç¤º
      Row() {
        Text(this.formatDisplayDate())
          .fontSize(16)
          .fontColor('#999999')

        Blank()

        Text('æ—¥åŽ†')
          .fontSize(16)
          .fontColor('#999999')
      }
      .width('90%')
      .margin({ bottom: 20 })

      // å‘¨æ—¥æœŸæ˜¾ç¤º
      Row() {
        ForEach(this.weekDays, (day: string, index: number) => {
          Column() {
            Text(day)
              .fontSize(12)
              .fontColor('#666666')
              .margin({ bottom: 4 })

            Text(this.currentWeekDates[index]?.toString() || '')
              .fontSize(14)
              .fontColor('#999999')

            if (this.currentWeekDates[index] === new Date(this.date).getDate()) {
              Circle()
                .width(4)
                .height(4)
                .fill(this.status === 'completed' ? '#00FF00' : '#FFA500')
                .margin({ top: 4 })
            }
          }
          .width('14.28%')
          .alignItems(HorizontalAlign.Center)
        })
      }
      .width('100%')
      .padding({ left: 16, right: 16 })
      .margin({ bottom: 40 })

      // è¾“å…¥æ¡†
      Column() {
        TextInput({ placeholder: 'å†™ç‚¹ä»€ä¹ˆ...' })
          .placeholderColor('#666666')
          .fontColor('#FFFFFF')
          .fontSize(16)
          .backgroundColor('#1A1A1A')
          .borderRadius(8)
          .padding(12)
          .onChange((value: string) => {
            this.note = value
          })
          .onClick(() => {
            // è·³è½¬åˆ°æ–‡å­—è¾“å…¥é¡µé¢
            this.getUIContext().getRouter().pushNamedRoute({
              name: 'pages/NoteInput',
              params: {
                text: this.note,
                date: this.date,
                status: this.status
              }
            })
          })
      }
      .width('90%')
      .margin({ bottom: 40 })

      // ç¡®è®¤æŒ‰é’®
      Button('âœ“')
        .fontSize(24)
        .fontColor('#FFFFFF')
        .backgroundColor('#FFA500')
        .width(60)
        .height(60)
        .borderRadius(30)
        .onClick(() => {
          this.saveRecord()
        })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#000000')
  }
}