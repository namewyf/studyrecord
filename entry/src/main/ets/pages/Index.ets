// Router is now accessed through UIContext
// PromptAction is now accessed through UIContext
import common from '@ohos.app.ability.common'
import { Notebook } from '../models/types'
import { StorageService } from '../services/StorageService'

@Entry
@Component
struct Index {
  @State notebooks: Notebook[] = []
  @State isLoading: boolean = true

  // é»˜è®¤æ‰“å¡æœ¬åˆ—è¡¨ï¼ˆé¦–æ¬¡ä½¿ç”¨æ—¶ï¼‰
  private defaultNotebooks: Notebook[] = [
    {
      id: 'paper',
      title: 'æ•°å­¦è¯•å·æ‰“å¡',
      icon: 'ðŸ“',
      color: '#4CAF50'
    },
    {
      id: 'exercise',
      title: 'æ•™è¾…ç»ƒä¹ æ‰“å¡',
      icon: 'ðŸ“š',
      color: '#FF4081'
    },
    {
      id: 'onboarding',
      title: 'æ–°ç”¨æˆ·çœ‹ä¸€çœ¼ï¼Œå°±çœ‹ä¸€çœ¼',
      icon: 'ðŸ™‹',
      color: '#FF9800'
    }
  ]

  aboutToAppear() {
    this.loadNotebooks()
  }

  onPageShow() {
    this.loadNotebooks()
  }

  async loadNotebooks() {
    try {
      const storageService = StorageService.getInstance()
      const context = getContext(this) as common.UIAbilityContext
      await storageService.init(context)

      let notebooks = await storageService.loadNotebooks()

      // å¦‚æžœæ˜¯é¦–æ¬¡ä½¿ç”¨ï¼Œä¿å­˜é»˜è®¤æ‰“å¡æœ¬
      if (notebooks.length === 0) {
        await storageService.saveNotebooks(this.defaultNotebooks)
        notebooks = this.defaultNotebooks
      }

      this.notebooks = notebooks
      this.isLoading = false
      console.info(`Loaded ${this.notebooks.length} notebooks`)
    } catch (error) {
      console.error('Failed to load notebooks:', error)
      this.notebooks = this.defaultNotebooks
      this.isLoading = false
    }
  }

  navigateToNotebook(notebook: Notebook) {
    this.getUIContext().getRouter().pushUrl({
      url: 'pages/NotebookCalendar',
      params: {
        notebook: notebook
      }
    })
  }

  navigateToCreateNotebook() {
    this.getUIContext().getRouter().pushUrl({
      url: 'pages/CreateNotebook'
    })
  }

  @Builder
  notebookCard(notebook: Notebook) {
    Column() {
      Text(notebook.icon)
        .fontSize(64)
        .margin({ bottom: 20 })

      Text(notebook.title)
        .fontSize(16)
        .fontColor('#FFFFFF')
        .textAlign(TextAlign.Center)
    }
    .width('45%')
    .height(200)
    .backgroundColor('#1A1A1A')
    .borderRadius(12)
    .justifyContent(FlexAlign.Center)
    .onClick(() => this.navigateToNotebook(notebook))
  }

  @Builder
  createNotebookCard() {
    Column() {
      Text('+')
        .fontSize(64)
        .fontColor('#666666')
        .margin({ bottom: 20 })

      Text('åˆ›å»ºæ‰“å¡æœ¬')
        .fontSize(16)
        .fontColor('#666666')
        .textAlign(TextAlign.Center)
    }
    .width('45%')
    .height(200)
    .backgroundColor('#1A1A1A')
    .borderRadius(12)
    .justifyContent(FlexAlign.Center)
    .onClick(() => this.navigateToCreateNotebook())
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Text('å­¦éœ¸æ‰“å¡')
          .fontSize(24)
          .fontColor('#FFFFFF')
          .fontWeight(FontWeight.Bold)

        Image($r('app.media.more'))
          .width(24)
          .height(24)
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16, top: 40 })
      .justifyContent(FlexAlign.SpaceBetween)
      .alignItems(VerticalAlign.Center)

      // æ‰“å¡æœ¬ç½‘æ ¼
      if (this.isLoading) {
        Text('åŠ è½½ä¸­...')
          .fontSize(16)
          .fontColor('#666666')
          .margin({ top: 100 })
      } else {
        Grid() {
          ForEach(this.notebooks, (notebook: Notebook) => {
            GridItem() {
              this.notebookCard(notebook)
            }
          }, (notebook: Notebook) => notebook.id)

          // åˆ›å»ºæŒ‰é’®
          GridItem() {
            this.createNotebookCard()
          }
        }
        .columnsTemplate('1fr 1fr')
        .rowsGap(20)
        .columnsGap(20)
        .width('100%')
        .padding({ left: 16, right: 16, top: 40 })
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#000000')
  }
}
