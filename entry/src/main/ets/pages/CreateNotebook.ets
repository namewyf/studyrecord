// Router is now accessed through UIContext
// PromptAction is now accessed through UIContext
import common from '@ohos.app.ability.common'
import { Notebook, NotebookItem } from '../models/types'
import { StorageService } from '../services/StorageService'
import { NotebookService } from '../services/NotebookService'
import { DefaultData } from '../services/DefaultData'
import { SlideButton } from '../components/SlideButton'

@Entry
@Component
struct CreateNotebook {
  @State notebookName: string = ''
  @State notebookIcon: string = 'ğŸš´'
  @State itemNames: string[] = ['æ‰“å¡äº‹é¡¹ä¸€', 'æ‰“å¡äº‹é¡¹äºŒ']
  @State itemIcons: string[] = ['âœ³ï¸', 'âŒ']

  private availableIcons: string[] = ['ğŸš´', 'ğŸ“—', 'ğŸ’•', 'ğŸ™‹', 'âš½', 'ğŸ®', 'ğŸµ', 'âœˆï¸', 'ğŸ•', 'â˜•']
  private availableItemIcons: string[] = ['âœ³ï¸', 'âŒ', 'âœ…', 'â­', 'â¤ï¸', 'ğŸ”¥', 'ğŸ’¡', 'ğŸ“Œ']
  private maxNameLength: number = 12

  aboutToAppear() {
    // éšæœºé€‰æ‹©ä¸€ä¸ªåˆå§‹å›¾æ ‡
    this.notebookIcon = this.availableIcons[Math.floor(Math.random() * this.availableIcons.length)]
  }

  refreshIcon() {
    // éšæœºæ›´æ¢å›¾æ ‡
    const currentIndex = this.availableIcons.indexOf(this.notebookIcon)
    let newIndex = Math.floor(Math.random() * this.availableIcons.length)
    while (newIndex === currentIndex) {
      newIndex = Math.floor(Math.random() * this.availableIcons.length)
    }
    this.notebookIcon = this.availableIcons[newIndex]
  }

  addItem() {
    const newName = `æ‰“å¡äº‹é¡¹${this.itemNames.length + 1}`
    const newIcon = this.availableItemIcons[this.itemNames.length % this.availableItemIcons.length]
    this.itemNames.push(newName)
    this.itemIcons.push(newIcon)
  }

  deleteItem(index: number) {
    this.itemNames.splice(index, 1)
    this.itemIcons.splice(index, 1)
  }

  async createNotebook() {
    if (!this.notebookName.trim()) {
      this.getUIContext().getPromptAction().showToast({
        message: 'è¯·è¾“å…¥æ‰“å¡æœ¬åç§°',
        duration: 2000
      })
      return
    }

    try {
      const storageService = StorageService.getInstance()
      const context = getContext(this) as common.UIAbilityContext
      await storageService.init(context)

      // åˆ›å»ºæ‰“å¡æœ¬çš„ID
      const notebookId = NotebookService.generateId('notebook')

      // åˆ›å»ºæ‰“å¡äº‹é¡¹
      const items: NotebookItem[] = []
      for (let i = 0; i < this.itemNames.length; i++) {
        const item = NotebookService.createNotebookItem(
          this.itemNames[i],
          this.itemIcons[i],
          notebookId,
          i + 1
        )
        items.push(item)
      }

      // åˆ›å»ºé»˜è®¤é€‰é¡¹
      const checkInOptions = DefaultData.createDifficultyOptions()

      // åˆ›å»ºæ–°æ‰“å¡æœ¬
      const newNotebook: Notebook = {
        id: notebookId,
        title: this.notebookName,
        icon: this.notebookIcon,
        checkInOptions: checkInOptions,
        items: items,
        createdAt: Date.now()
      }

      await storageService.saveNotebook(newNotebook)

      this.getUIContext().getPromptAction().showToast({
        message: 'æ‰“å¡æœ¬åˆ›å»ºæˆåŠŸ',
        duration: 2000
      })

      // è¿”å›é¦–é¡µ
      this.getUIContext().getRouter().back()
    } catch (error) {
      console.error('Failed to create notebook:', error)
      this.getUIContext().getPromptAction().showToast({
        message: 'åˆ›å»ºå¤±è´¥ï¼Œè¯·é‡è¯•',
        duration: 2000
      })
    }
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆª
      Row() {
        Image($r('app.media.back'))
          .width(24)
          .height(24)
          .onClick(() => {
            this.getUIContext().getRouter().back()
          })

        Blank()
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 56, bottom: 16 })

      Scroll() {
        Column() {
          // å›¾æ ‡é€‰æ‹©
          Column() {
            Text(this.notebookIcon)
              .fontSize(80)
              .margin({ bottom: 20 })

            Row() {
              Text('æ‰“å¡å›¾æ ‡')
                .fontSize(16)
                .fontColor('#FFFFFF')

              Blank()

              // åˆ·æ–°å›¾æ ‡æŒ‰é’®
              Image($r('app.media.startIcon'))
                .width(20)
                .height(20)
                .fillColor('#999999')
                .onClick(() => {
                  this.refreshIcon()
                })
            }
            .width('90%')
            .margin({ bottom: 40 })
          }
          .width('100%')
          .alignItems(HorizontalAlign.Center)
          .margin({ top: 20 })

          // æ‰“å¡æœ¬åç§°è¾“å…¥
          Column() {
            Row() {
              Text('æ‰“å¡æœ¬åç§°')
                .fontSize(16)
                .fontColor('#FFFFFF')
            }
            .width('100%')
            .margin({ bottom: 10 })

            Column() {
              TextInput({ placeholder: 'è®°å½•ä»€ä¹ˆå‘¢â€¦' })
                .placeholderColor('#666666')
                .fontColor('#FFFFFF')
                .fontSize(16)
                .backgroundColor('transparent')
                .border({ width: 0 })
                .onChange((value: string) => {
                  if (value.length <= this.maxNameLength) {
                    this.notebookName = value
                  }
                })

              Row() {
                Blank()
                Text(`${this.notebookName.length}/${this.maxNameLength}`)
                  .fontSize(12)
                  .fontColor('#666666')
              }
              .width('100%')
            }
            .width('100%')
            .padding({ left: 12, right: 12, top: 8, bottom: 8 })
            .backgroundColor('#1A1A1A')
            .borderRadius(8)
          }
          .width('90%')
          .alignSelf(ItemAlign.Center)
          .margin({ bottom: 40 })

          // æ‰“å¡äº‹é¡¹
          Column() {
            Row() {
              Text('æ‰“å¡äº‹é¡¹')
                .fontSize(16)
                .fontColor('#FFFFFF')
            }
            .width('100%')
            .margin({ bottom: 20 })

            // äº‹é¡¹åˆ—è¡¨
            ForEach(this.itemNames, (itemName: string, index: number) => {
              Row() {
                // æ‹–åŠ¨æ‰‹æŸ„
                Text('::')
                  .fontSize(20)
                  .fontColor('#666666')
                  .margin({ right: 16 })

                // å›¾æ ‡
                Text(this.itemIcons[index])
                  .fontSize(32)
                  .margin({ right: 16 })

                // åç§°
                Text(itemName)
                  .fontSize(16)
                  .fontColor('#FFFFFF')
                  .layoutWeight(1)

                // å³ç®­å¤´
                Image($r('app.media.arrow_down'))
                  .width(16)
                  .height(16)
                  .fillColor('#666666')
                  .rotate({ angle: -90 })
              }
              .width('100%')
              .height(60)
              .padding({ left: 12, right: 12 })
              .backgroundColor('#1A1A1A')
              .borderRadius(8)
              .margin({ bottom: 12 })
              .gesture(
                LongPressGesture()
                  .onAction(() => {
                    // é•¿æŒ‰åˆ é™¤
                    this.deleteItem(index)
                  })
              )
            }, (itemName: string, index: number) => `${index}_${itemName}`)

            // æ–°å¢äº‹é¡¹æŒ‰é’®
            Row() {
              Image($r('app.media.startIcon'))
                .width(24)
                .height(24)
                .fillColor('#666666')
                .margin({ right: 12 })

              Text('æ–°å¢æ‰“å¡äº‹é¡¹')
                .fontSize(16)
                .fontColor('#999999')
            }
            .width('100%')
            .height(60)
            .justifyContent(FlexAlign.Start)
            .padding({ left: 12 })
            .onClick(() => {
              this.addItem()
            })
          }
          .width('90%')
          .alignSelf(ItemAlign.Center)
          .margin({ bottom: 40 })

          // æ»‘åŠ¨åˆ›å»ºæŒ‰é’®
          SlideButton({
            text: 'æ»‘åŠ¨åˆ›å»ºæ‰“å¡æœ¬',
            onConfirm: () => {
              this.createNotebook()
            }
          })
          .width('90%')
          .alignSelf(ItemAlign.Center)
          .margin({ bottom: 60 })
        }
      }
      .layoutWeight(1)
      .scrollBar(BarState.Off)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#000000')
  }
}
