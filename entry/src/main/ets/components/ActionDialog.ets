import { CheckInOption } from '../models/types'
import { NotebookService } from '../services/NotebookService'

/**
 * æ‰“å¡é€‰é¡¹å¯¹è¯æ¡†ï¼ˆåŠ¨æ€æ¸²æŸ“ï¼‰
 */
@CustomDialog
export struct ActionDialog {
  controller?: CustomDialogController
  notebookId: string = ''  // æ‰“å¡æœ¬ID
  onOptionSelected: (optionId: string) => void = () => {}  // å›žè°ƒï¼šç”¨æˆ·é€‰æ‹©äº†æŸä¸ªé€‰é¡¹

  @State options: CheckInOption[] = []  // åŠ¨æ€åŠ è½½çš„é€‰é¡¹åˆ—è¡¨
  @State dialogTitle: string = 'æ‰“å¡'  // å¯¹è¯æ¡†æ ‡é¢˜
  @State isLoading: boolean = true

  async aboutToAppear() {
    await this.loadOptions()
  }

  /**
   * åŠ¨æ€åŠ è½½è¯¥æ‰“å¡æœ¬çš„é€‰é¡¹
   */
  async loadOptions() {
    try {
      this.isLoading = true
      this.options = await NotebookService.getNotebookOptions(this.notebookId)
      // è¿™é‡Œå¯ä»¥æ ¹æ®æ‰“å¡æœ¬é…ç½®åŠ è½½æ ‡é¢˜ï¼Œæš‚æ—¶ç¡¬ç¼–ç 
      this.dialogTitle = 'è¿™å¼ è¯•å·æ€Žä¹ˆæ ·'
      this.isLoading = false
      console.info(`Loaded ${this.options.length} options for notebook ${this.notebookId}`)
    } catch (error) {
      console.error('Failed to load options:', error)
      this.isLoading = false
    }
  }

  /**
   * æ¸²æŸ“å•ä¸ªé€‰é¡¹
   */
  @Builder
  buildOption(option: CheckInOption) {
    Column() {
      Row() {
        Row() {
          // ä½¿ç”¨åœ†å½¢è‰²å—ä»£æ›¿å›¾æ ‡ï¼ˆæš‚æ—¶ï¼‰
          Circle()
            .width(40)
            .height(40)
            .fill(option.color || '#FFFFFF')
            .margin({ right: 12 })

          Column() {
            Text(option.name)  // âœ… ä»Žæ•°æ®è¯»å–åç§°
              .fontSize(16)
              .fontColor('#FFFFFF')
              .fontWeight(FontWeight.Medium)
          }
          .alignItems(HorizontalAlign.Start)
        }

        Image($r('app.media.arrow_right'))
          .width(20)
          .height(20)
      }
      .width('100%')
      .padding(16)
      .justifyContent(FlexAlign.SpaceBetween)
      .onClick(() => {
        this.onOptionSelected(option.id)  // âœ… ä¼ é€’é€‰é¡¹ID
        // æ³¨æ„ï¼šå¯¹è¯æ¡†å…³é—­ç”±å›žè°ƒå‡½æ•°å¤„ç†ï¼Œé¿å…é‡å¤å…³é—­
      })
    }
    .width('90%')
    .backgroundColor('#1A1A1A')
    .borderRadius(8)
    .margin({ bottom: 12 })
  }

  build() {
    Column() {
      // é¡¶éƒ¨å…³é—­æŒ‰é’®
      Row() {
        Image($r('app.media.close'))
          .width(24)
          .height(24)
          .onClick(() => {
            this.controller?.close()
          })

        Blank()
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 16 })

      // å¯¹è¯æ¡†æ ‡é¢˜
      Text(this.dialogTitle)
        .fontSize(18)
        .fontColor('#FFFFFF')
        .margin({ top: 20, bottom: 30 })

      // åŠ è½½çŠ¶æ€æˆ–é€‰é¡¹åˆ—è¡¨
      if (this.isLoading) {
        Text('åŠ è½½ä¸­...')
          .fontSize(14)
          .fontColor('#999999')
          .margin({ top: 20, bottom: 20 })
      } else if (this.options.length === 0) {
        Text('æš‚æ— é€‰é¡¹')
          .fontSize(14)
          .fontColor('#999999')
          .margin({ top: 20, bottom: 20 })
      } else {
        // ðŸ”¥ åŠ¨æ€æ¸²æŸ“æ‰€æœ‰é€‰é¡¹
        ForEach(this.options, (option: CheckInOption) => {
          this.buildOption(option)
        }, (option: CheckInOption) => option.id)
      }

      Blank()
        .height(30)
    }
    .width('100%')
    .backgroundColor('#000000')
    .borderRadius({ topLeft: 20, topRight: 20 })
  }
}
